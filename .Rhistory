theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Regions.png',REGION_CONTRIBUTION,dev="png",limitsize=TRUE, bg='transparent')
### PROVINCES ANALYSIS
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-province/dpc-covid19-ita-province.csv'
# LOAD DATA
summary_table <- read.csv(summary_file)
summary_table$data <- as.Date(summary_table$data)
summary_table$data <- as.Date(format(summary_table$data,format='%Y-%m-%d'))
today <- max(summary_table$data)
kept <- c("denominazione_provincia","totale_casi","data")
summary <- summary_table[,kept]
summary <- melt(summary, id=c("denominazione_provincia","data"))
colnames(summary) <- c("Provincia","Data","Categoria","Casi")
Today_TOT <- sum(summary[summary$Data == today,'Casi'])
collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
summary_others <- summary[summary$Provincia %in% collapse_these,]
summary_top <- summary[!(summary$Provincia %in% collapse_these),]
summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
summary_full <- rbind(summary_top,summary_others)
level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
scale_fill_brewer("",palette = "Paired") +
scale_y_continuous(position="right") + labs(x="",y="") +
ggtitle(paste("SARS-COV-2 in Italia, casi per provincia (agg.",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Provinces.png',PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# for (myregion in unique(summary_table$denominazione_regione))
#
# {
#
#   summary = summary_table[summary_table$denominazione_regione == myregion,]
#
# kept <- c("denominazione_provincia","totale_casi","data")
# summary <- summary[,kept]
# summary <- melt(summary, id=c("denominazione_provincia","data"))
#
# colnames(summary) <- c("Provincia","Data","Categoria","Casi")
#
# Today_TOT <- sum(summary[summary$Data == today,'Casi'])
#
# print(Today_TOT)
#
# collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
# print(myregion)
# print(collapse_these)
#
# summary_others <- summary[summary$Provincia %in% collapse_these,]
# summary_top <- summary[!(summary$Provincia %in% collapse_these),]
#
# summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
# summary_full <- rbind(summary_top,summary_others)
#
# level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
#
# PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
#   scale_fill_brewer("",palette = "Paired") +
#   scale_y_continuous(position="right") + labs(x="",y="") +
#   ggtitle(paste("SARS-COV-2 in ", myregion," (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
#   scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
#   theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
#   geom_area()
#
# ggsave(paste("plot_",str_replace(myregion," ","_"),"_byProvince.png",sep=""), PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# }
# LOAD LIBRARIES
library(dplyr)
library(ggplot2)
library(reshape2)
library(forcats)
# INPUT FILE
summary_file <- summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv'
# LOAD DATA
summary <- read.csv(summary_file)
edit(summary)
# CLEAN DATA
summary$data <- as.Date(summary$data)
summary$data <- as.Date(format(summary$data,format='%Y-%m-%d'))
today <- max(summary$data)
kept <- c("denominazione_regione","ricoverati_con_sintomi","terapia_intensiva",
"isolamento_domiciliare","dimessi_guariti","deceduti","data")
summary <- summary[,kept]
summary <- melt(summary, id=c("denominazione_regione","data"))
colnames(summary) <- c("Regione","Data","Categoria","Casi")
levels(summary$Categoria) <- c("Ricoverati con sintomi","Terapia intensiva","Isolamento domiciliare","Dimessi guariti", "Deceduti")
colormap <- c("Ricoverati con sintomi" = "darkorange1",
"Terapia intensiva" = "firebrick2",
"Isolamento domiciliare" = "deepskyblue3",
"Dimessi guariti" = "#50C878",
"Deceduti" = "grey35")
ITALYPLOT <- ggplot(data=summary, mapping=aes(x=Data, y=Casi, fill=factor(Categoria, levels = c("Dimessi guariti","Isolamento domiciliare","Ricoverati con sintomi","Terapia intensiva","Deceduti")))) +
geom_bar(stat="identity") +
scale_fill_manual("", values = colormap) +
ggtitle(paste("SARS-COV-2 in Italia (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
scale_y_continuous(position="right") + labs(x="",y="") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank())
ggsave('plot_Italy.png',ITALYPLOT,dev="png",limitsize=TRUE, bg='transparent')
for (myregion in unique(summary$Regione))
{
if(myregion %in% c('Bolzano','Trento')) {
myregion_name = paste('nella Provincia Autonoma di ',myregion, sep="")} else if (myregion=="Marche") {
myregion_name = paste('nelle ',myregion,sep="")
} else {
myregion_name = paste('in ',myregion,sep="")
}
REGIONPLOT <- ggplot(data=summary[summary$Regione==myregion,], mapping=aes(x=Data, y=Casi, fill=factor(Categoria, levels = c("Dimessi guariti","Isolamento domiciliare","Ricoverati con sintomi","Terapia intensiva","Deceduti")))) +
geom_bar(stat="identity") +
scale_fill_manual("", values = colormap) +
ggtitle(paste("SARS-COV-2 ",myregion_name," (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
scale_y_continuous(position="right") + labs(x="",y="")
ggsave(paste("plot_",gsub(" ","_",myregion),".png",sep=""),REGIONPLOT,limitsize=TRUE, bg='transparent')
}
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv'
# LOAD DATA
summary <- read.csv(summary_file)
edit(summary)
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv'
# LOAD DATA
summary <- read.csv(summary_file)
summary$data <- as.Date(summary$data)
summary$data <- as.Date(format(summary$data,format='%Y-%m-%d'))
today <- max(summary$data)
kept <- c("denominazione_regione","totale_casi","data")
summary <- summary[,kept]
summary <- melt(summary, id=c("denominazione_regione","data"))
colnames(summary) <- c("Regione","Data","Categoria","Casi")
Today_TOT <- sum(summary[summary$Data == today,'Casi'])
collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Regione']
summary_others <- summary[summary$Regione %in% collapse_these,]
summary_top <- summary[!(summary$Regione %in% collapse_these),]
summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Regione="Altre") %>% mutate(Categoria="totale_casi")
summary_full <- rbind(summary_top,summary_others)
level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Regione!="Altre"),'Regione']),summary_full[(summary_full$Data==today)&(summary_full$Regione!="Altre"),'Casi'],.desc=TRUE),"Altre")
REGION_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Regione,levels=levels(level_order)))) +
scale_fill_brewer("",palette = "Set1") +
scale_y_continuous(position="right") + labs(x="",y="") +
ggtitle(paste("SARS-COV-2 in Italia, casi per regione (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Regions.png',REGION_CONTRIBUTION,dev="png",limitsize=TRUE, bg='transparent')
### PROVINCES ANALYSIS
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-province/dpc-covid19-ita-province.csv'
# LOAD DATA
summary_table <- read.csv(summary_file)
summary_table$data <- as.Date(summary_table$data)
summary_table$data <- as.Date(format(summary_table$data,format='%Y-%m-%d'))
today <- max(summary_table$data)
kept <- c("denominazione_provincia","totale_casi","data")
summary <- summary_table[,kept]
summary <- melt(summary, id=c("denominazione_provincia","data"))
colnames(summary) <- c("Provincia","Data","Categoria","Casi")
Today_TOT <- sum(summary[summary$Data == today,'Casi'])
collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
summary_others <- summary[summary$Provincia %in% collapse_these,]
summary_top <- summary[!(summary$Provincia %in% collapse_these),]
summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
summary_full <- rbind(summary_top,summary_others)
level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
scale_fill_brewer("",palette = "Paired") +
scale_y_continuous(position="right") + labs(x="",y="") +
ggtitle(paste("SARS-COV-2 in Italia, casi per provincia (agg.",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Provinces.png',PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# for (myregion in unique(summary_table$denominazione_regione))
#
# {
#
#   summary = summary_table[summary_table$denominazione_regione == myregion,]
#
# kept <- c("denominazione_provincia","totale_casi","data")
# summary <- summary[,kept]
# summary <- melt(summary, id=c("denominazione_provincia","data"))
#
# colnames(summary) <- c("Provincia","Data","Categoria","Casi")
#
# Today_TOT <- sum(summary[summary$Data == today,'Casi'])
#
# print(Today_TOT)
#
# collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
# print(myregion)
# print(collapse_these)
#
# summary_others <- summary[summary$Provincia %in% collapse_these,]
# summary_top <- summary[!(summary$Provincia %in% collapse_these),]
#
# summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
# summary_full <- rbind(summary_top,summary_others)
#
# level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
#
# PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
#   scale_fill_brewer("",palette = "Paired") +
#   scale_y_continuous(position="right") + labs(x="",y="") +
#   ggtitle(paste("SARS-COV-2 in ", myregion," (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
#   scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
#   theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
#   geom_area()
#
# ggsave(paste("plot_",str_replace(myregion," ","_"),"_byProvince.png",sep=""), PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# }
# LOAD LIBRARIES
library(dplyr)
library(ggplot2)
library(reshape2)
library(forcats)
# INPUT FILE
summary_file <- summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv'
# LOAD DATA
summary <- read.csv(summary_file)
edit(summary)
# CLEAN DATA
summary$data <- as.Date(summary$data)
summary$data <- as.Date(format(summary$data,format='%Y-%m-%d'))
today <- max(summary$data)
kept <- c("denominazione_regione","ricoverati_con_sintomi","terapia_intensiva",
"isolamento_domiciliare","dimessi_guariti","deceduti","data")
summary <- summary[,kept]
summary <- melt(summary, id=c("denominazione_regione","data"))
colnames(summary) <- c("Regione","Data","Categoria","Casi")
levels(summary$Categoria) <- c("Ricoverati con sintomi","Terapia intensiva","Isolamento domiciliare","Dimessi guariti", "Deceduti")
colormap <- c("Ricoverati con sintomi" = "darkorange1",
"Terapia intensiva" = "firebrick2",
"Isolamento domiciliare" = "deepskyblue3",
"Dimessi guariti" = "#50C878",
"Deceduti" = "grey35")
ITALYPLOT <- ggplot(data=summary, mapping=aes(x=Data, y=Casi, fill=factor(Categoria, levels = c("Dimessi guariti","Isolamento domiciliare","Ricoverati con sintomi","Terapia intensiva","Deceduti")))) +
geom_bar(stat="identity") +
scale_fill_manual("", values = colormap) +
ggtitle(paste("SARS-COV-2 in Italia (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
scale_y_continuous(position="right") + labs(x="",y="") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank())
ggsave('plot_Italy.png',ITALYPLOT,dev="png",limitsize=TRUE, bg='transparent')
for (myregion in unique(summary$Regione))
{
if(myregion %in% c('Bolzano','Trento')) {
myregion_name = paste('nella Provincia Autonoma di ',myregion, sep="")} else if (myregion=="Marche") {
myregion_name = paste('nelle ',myregion,sep="")
} else {
myregion_name = paste('in ',myregion,sep="")
}
REGIONPLOT <- ggplot(data=summary[summary$Regione==myregion,], mapping=aes(x=Data, y=Casi, fill=factor(Categoria, levels = c("Dimessi guariti","Isolamento domiciliare","Ricoverati con sintomi","Terapia intensiva","Deceduti")))) +
geom_bar(stat="identity") +
scale_fill_manual("", values = colormap) +
ggtitle(paste("SARS-COV-2 ",myregion_name," (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
scale_y_continuous(position="right") + labs(x="",y="")
ggsave(paste("plot_",gsub(" ","_",myregion),".png",sep=""),REGIONPLOT,limitsize=TRUE, bg='transparent')
}
### REGION ANALYSIS
### REGION ANALYSIS
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv'
# LOAD DATA
summary <- read.csv(summary_file)
edit(summary)
summary$data <- as.Date(summary$data)
summary$data <- as.Date(format(summary$data,format='%Y-%m-%d'))
today <- max(summary$data)
kept <- c("denominazione_regione","totale_casi","data")
summary <- summary[,kept]
summary <- melt(summary, id=c("denominazione_regione","data"))
colnames(summary) <- c("Regione","Data","Categoria","Casi")
Today_TOT <- sum(summary[summary$Data == today,'Casi'])
collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Regione']
summary_others <- summary[summary$Regione %in% collapse_these,]
summary_top <- summary[!(summary$Regione %in% collapse_these),]
summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Regione="Altre") %>% mutate(Categoria="totale_casi")
summary_full <- rbind(summary_top,summary_others)
level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Regione!="Altre"),'Regione']),summary_full[(summary_full$Data==today)&(summary_full$Regione!="Altre"),'Casi'],.desc=TRUE),"Altre")
REGION_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Regione,levels=levels(level_order)))) +
scale_fill_brewer("",palette = "Set1") +
scale_y_continuous(position="right") + labs(x="",y="") +
ggtitle(paste("SARS-COV-2 in Italia, casi per regione (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Regions.png',REGION_CONTRIBUTION,dev="png",limitsize=TRUE, bg='transparent')
### PROVINCES ANALYSIS
# INPUT FILE
summary_file <- 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-province/dpc-covid19-ita-province.csv'
# LOAD DATA
summary_table <- read.csv(summary_file)
edit(summary_table)
summary_table$data <- as.Date(summary_table$data)
summary_table$data <- as.Date(format(summary_table$data,format='%Y-%m-%d'))
today <- max(summary_table$data)
kept <- c("denominazione_provincia","totale_casi","data")
summary <- summary_table[,kept]
summary <- melt(summary, id=c("denominazione_provincia","data"))
colnames(summary) <- c("Provincia","Data","Categoria","Casi")
Today_TOT <- sum(summary[summary$Data == today,'Casi'])
collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
summary_others <- summary[summary$Provincia %in% collapse_these,]
summary_top <- summary[!(summary$Provincia %in% collapse_these),]
summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
summary_full <- rbind(summary_top,summary_others)
level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
scale_fill_brewer("",palette = "Paired") +
scale_y_continuous(position="right") + labs(x="",y="") +
ggtitle(paste("SARS-COV-2 in Italia, casi per provincia (agg.",format(today,"%d/%m/%y"),")",sep="")) +
scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
geom_area()
ggsave('plot_Provinces.png',PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# for (myregion in unique(summary_table$denominazione_regione))
#
# {
#
#   summary = summary_table[summary_table$denominazione_regione == myregion,]
#
# kept <- c("denominazione_provincia","totale_casi","data")
# summary <- summary[,kept]
# summary <- melt(summary, id=c("denominazione_provincia","data"))
#
# colnames(summary) <- c("Provincia","Data","Categoria","Casi")
#
# Today_TOT <- sum(summary[summary$Data == today,'Casi'])
#
# print(Today_TOT)
#
# collapse_these <- summary[(summary$Data == today)&(summary$Casi<=Today_TOT/20),'Provincia']
# print(myregion)
# print(collapse_these)
#
# summary_others <- summary[summary$Provincia %in% collapse_these,]
# summary_top <- summary[!(summary$Provincia %in% collapse_these),]
#
# summary_others <- summary_others[,c('Data','Casi')] %>% group_by(Data) %>% summarise_all(funs(sum)) %>% mutate(Provincia="Altre") %>% mutate(Categoria="totale_casi")
# summary_full <- rbind(summary_top,summary_others)
#
# level_order <- fct_expand(fct_reorder(factor(summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Provincia']),summary_full[(summary_full$Data==today)&(summary_full$Provincia!="Altre"),'Casi'],.desc=TRUE),"Altre")
#
# PROVINCE_CONTRIBUTION <- ggplot(summary_full, aes(x=Data, y=Casi, fill=factor(Provincia,levels=levels(level_order)))) +
#   scale_fill_brewer("",palette = "Paired") +
#   scale_y_continuous(position="right") + labs(x="",y="") +
#   ggtitle(paste("SARS-COV-2 in ", myregion," (agg. ",format(today,"%d/%m/%y"),")",sep="")) +
#   scale_x_date(date_labels="%d/%m", date_breaks="2 days") +
#   theme(legend.position="bottom", legend.background = element_rect(color = NA), panel.grid.minor = element_blank()) +
#   geom_area()
#
# ggsave(paste("plot_",str_replace(myregion," ","_"),"_byProvince.png",sep=""), PROVINCE_CONTRIBUTION,dev="png", bg='transparent')
#
# }
# SET WORKING DIRECTORY
setwd("~/GIT_folder/coronavirus_lombardia")
# LOAD LIBRARIES
library(dplyr)
library(ggplot2)
library(reshape2)
library(forcats)
library(showtext)
library(gridExtra)
library(grid)
library(htmltools)
library(webshot)
library(formattable)
export_formattable <- function(f, file, width = "80%", height = NULL,
background = "white", delay = 0.2)
{
w <- as.htmlwidget(f, width = width, height = height)
path <- html_print(w, background = background, viewer = NULL)
url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
webshot(url,
file = file,
selector = ".formattable_widget",
delay = delay)
}
# LOAD FONT
font_add(family='Roboto', regular='C:/Users/asus/Downloads/Roboto/Roboto-Light.ttf')
# WRITE README HEADER
s1="<div align='center'><h1>L'epidemia di coronavirus in Lombardia</h1></div>"
s2="<div>I grafici seguenti descrivono l'andamento dell'epidemia di COVID-19 in Lombardia. I dati di riferimento sono quelli rilasciati quotidianamente da <a href='http://lispa.maps.arcgis.com/apps/opsdashboard/index.html#/637ec3dc28ec4ea591cc5c724f127701' target='_blank'>Regione Lombardia</a>, e organizzati in <a href='https://github.com/ondata/covid19italia/blob/master/webservices/regioneLombardia/processing/INCR_DATE_PRV_TAMP_RL_v2/' target='_blank'>file CSV</a> dall'associazione OnData."
s3="A differenza dei dati ufficiali della <a href='https://github.com/pcm-dpc/COVID-19' target='_blank'>Protezione Civile</a>, Regione Lombardia inserisce i risultati dei nuovi tamponi positivi alla data in cui è stato eseguito il prelievo, pertanto le curve di crescita qui riportate saranno leggermente differenti rispetto a quelli basati sul dataset nazionale gestito dalla Protezione Civile."
s4="Ciascun grafico è accompagnato da una tabella che riporta le modifiche introdotte dall'ultimo aggiornamento. Da queste tabelle è possibile conoscere la data effettiva del prelievo per i nuovi tamponi positivi.</div>"
s5='<hr>'
write(c(s1,s2,s3,s4,s5),file="README.md", append=FALSE)
# INPUT FILES
yesterday_file <- 'https://github.com/ondata/covid19italia/raw/master/webservices/regioneLombardia/processing/INCR_DATE_PRV_TAMP_RL_v2/2020-03-30-INCR_DATE_PRV_TAMP_RL_v2.csv'
today_file <- 'https://github.com/ondata/covid19italia/raw/master/webservices/regioneLombardia/processing/INCR_DATE_PRV_TAMP_RL_v2/2020-03-31-INCR_DATE_PRV_TAMP_RL_v2.csv'
# MY DATAFRAMES
yesterday <- read.csv(yesterday_file)
today <- read.csv(today_file)
# FIX DATES
yesterday$DATA_RICEVIMENTO_TAMPONE <- as.Date(as.character(yesterday$DATA_RICEVIMENTO_TAMPONE),"%Y%m%d")
today$DATA_RICEVIMENTO_TAMPONE <- as.Date(as.character(today$DATA_RICEVIMENTO_TAMPONE),"%Y%m%d")
# DATE VARIABLES
today_date <- max(today$DATA_RICEVIMENTO_TAMPONE)
yesterday_date <- max(yesterday$DATA_RICEVIMENTO_TAMPONE)
# MERGE
df <- merge(today,yesterday,by=c('PROVINCIA','DATA_RICEVIMENTO_TAMPONE'),all=TRUE)
lombardia_df <- aggregate(INCREMENTO.x ~ DATA_RICEVIMENTO_TAMPONE, df[,c('DATA_RICEVIMENTO_TAMPONE','INCREMENTO.x')], sum)
# ACTIVATE SHOWTEXT
showtext_auto()
x11()
TREND_PLOT <- ggplot(data=lombardia_df,aes(x=DATA_RICEVIMENTO_TAMPONE,y=INCREMENTO.x)) +
geom_line(size=1,color="SeaGreen") + geom_point(size=3,color="SeaGreen") +
ggtitle(paste("COVID-19 in LOMBARDIA (agg. ",format(today_date,"%d/%m/%y"),")",sep="")) +
labs(x="",y="") +
scale_x_date(date_labels="%d/%m") +
scale_y_continuous(position="right") +
theme_classic() +
theme(legend.title = element_blank(),
legend.position="bottom",
legend.background = element_rect(color = NA),
panel.grid.major = element_line(colour = 'grey',size=0.3),
panel.grid.minor = element_blank(),
panel.grid.major.x=element_blank(),
plot.margin=unit(c(1,0,1,0.5),"cm"),
axis.title=element_text(size=45,family="Roboto",margin = unit(c(3, 0, 0, 0), "cm")),
legend.text=element_text(size=45,family='Roboto'),
plot.title = element_text(size=60, family='Roboto'),
axis.text.x = element_text(size=40,family='Roboto'),
axis.text.y = element_text(size=40,family='Roboto'))
ggsave('img/trend_lombardia.png',TREND_PLOT,dev="png", width = 11, height = 8, units='in', bg='transparent')
# TURN OFF SHOWTEXT
showtext_auto(FALSE)
# COLLECT VARIATIONS
increase_DF <- data.frame(PROVINCIA=character(), TOTALE=integer(), AUMENTO=integer())
# LOOP OVER PROVINCES
for (PROV in unique(df$PROVINCIA)) {
this_df <- df[df$PROVINCIA==PROV,]
yesterday_total <- this_df[this_df$DATA_RICEVIMENTO_TAMPONE==yesterday_date,"INCREMENTO.y"]
today_total <- this_df[this_df$DATA_RICEVIMENTO_TAMPONE==today_date,"INCREMENTO.x"]
this_increase <- today_total - yesterday_total
this_increase_DF <- data.frame(PROVINCIA=PROV,TOTALE=today_total,AUMENTO=this_increase)
increase_DF <- rbind(increase_DF,this_increase_DF)
# CALCULATE DELTA
this_df$NUM_TAMP.y[is.na(this_df$NUM_TAMP.y)] <- 0
this_df$VARIAZIONE <- this_df$NUM_TAMP.x - this_df$NUM_TAMP.y
this_df$VARIAZIONE <- ifelse(this_df$VARIAZIONE>0, paste0("+", this_df$VARIAZIONE), this_df$VARIAZIONE)
# EXTRACT CHANGES
if (PROV != "IGNOTA") {
this_df2 <- this_df[(this_df$VARIAZIONE!=0),c("PROVINCIA","DATA_RICEVIMENTO_TAMPONE","VARIAZIONE")]
# ACTIVATE SHOWTEXT
showtext_auto()
x11()
TREND_PLOT <- ggplot(data=this_df,aes(x=DATA_RICEVIMENTO_TAMPONE,y=INCREMENTO.x)) +
geom_line(size=1,color="deepskyblue3") + geom_point(size=3,color="deepskyblue3") +
ggtitle(paste("COVID-19 in provincia di ",PROV," (agg. ",format(today_date,"%d/%m/%y"),")",sep="")) +
labs(x="",y="") +
scale_x_date(date_labels="%d/%m") +
scale_y_continuous(position="right") +
theme_classic() +
theme(legend.title = element_blank(),
legend.position="bottom",
legend.background = element_rect(color = NA),
panel.grid.major = element_line(colour = 'grey',size=0.3),
panel.grid.minor = element_blank(),
panel.grid.major.x=element_blank(),
plot.margin=unit(c(1,0,1,0.5),"cm"),
axis.title=element_text(size=45,family="Roboto",margin = unit(c(3, 0, 0, 0), "cm")),
legend.text=element_text(size=45,family='Roboto'),
plot.title = element_text(size=60, family='Roboto'),
axis.text.x = element_text(size=40,family='Roboto'),
axis.text.y = element_text(size=40,family='Roboto'))
ggsave(paste('img/trend_',gsub(" ","_",PROV),'.png',sep=""),TREND_PLOT,dev="png", width = 11, height = 8, units='in', bg='transparent')
# TURN OFF SHOWTEXT
showtext_auto(FALSE)
this_df2$DATA_RICEVIMENTO_TAMPONE = format(this_df2$DATA_RICEVIMENTO_TAMPONE,"%d/%m")
PROV_TABLE <- formattable(this_df2,
row.names=FALSE,
align=c('c','c','c'),
list(VARIAZIONE = formatter("span",
style = x ~ style(color = ifelse(startsWith(x,"-") , "red", "green")))))
export_formattable(PROV_TABLE,paste('img/table_',gsub(" ","_",PROV),".png",sep=""))
}
}
# TOTAL INCREASE
tot_increase <- sum(increase_DF$AUMENTO)
TABLE <- formattable(increase_DF,
row.names=FALSE,
align=c('c','c','l'),
list(
AUMENTO = formatter("span",
style = x ~ style(display = "inline-block",direction = "ltr","border-radius" = "4px","background-color" = csscolor("lightgreen"),width = percent(proportion(x))))
))
export_formattable(TABLE,"img/mytable.png")
# COMPLETE README
s1=paste('<div align="center"><img src="img/trend_lombardia.png?raw=true" width="100%"/></div>',sep="")
s2=paste('<div align="center"><img src="img/mytable.png?raw=true" width="100%"/></div>',sep="")
s3='<hr>'
write(c(s1,s2,s3),file="README.md", append=TRUE)
for (PROV in unique(df$PROVINCIA)) {
if (PROV != "IGNOTA") {
x1=paste('<div align="center"><img src="img/trend_',gsub(" ","_",gsub("\\*","",PROV)),'.png?raw=true" width="100%"/></div>',sep="")
x2=paste('<div align="center"><img src="img/table_',gsub(" ","_",gsub("\\*","",PROV)),'.png?raw=true" width="100%"/></div>',sep="")
x3='<hr>'
write(c(x1,x2,x3),file="README.md", append=TRUE)
}
}
